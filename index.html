<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LevelUp Admin - Sécurité Avancée</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@500;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #020617; 
            color: #f8fafc;
            background-image: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.1) 0%, transparent 40%);
            min-height: 100vh;
        }

        .admin-card { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(16px); 
        }

        #auth-overlay, #forbidden-overlay {
            background: rgba(2, 6, 23, 0.98);
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .console-log { font-family: monospace; font-size: 10px; }
        ::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="p-4 md:p-12">

    <!-- Écran de Connexion -->
    <div id="auth-overlay" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="admin-card p-10 rounded-[2.5rem] w-full max-w-md text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-black uppercase mb-2">Panel Privé</h2>
            <p class="text-slate-400 text-sm mb-8">Connectez-vous pour continuer</p>
            
            <button onclick="handleGoogleLogin()" id="login-btn" class="w-full py-4 bg-white text-slate-900 font-bold rounded-2xl hover:bg-slate-200 flex items-center justify-center gap-3 transition-all">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                Continuer avec Google
            </button>
        </div>
    </div>

    <!-- Écran ACCÈS INTERDIT -->
    <div id="forbidden-overlay" class="fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="admin-card p-10 rounded-[2.5rem] w-full max-w-md text-center border-red-500/30">
            <div class="w-20 h-20 bg-red-500/20 border border-red-500/50 rounded-3xl flex items-center justify-center mx-auto mb-6">
                <i data-lucide="ban" class="text-red-500 w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-black uppercase text-red-500 mb-2">Accès Refusé</h2>
            <p id="forbidden-msg" class="text-slate-400 text-sm mb-8">Votre compte n'est pas autorisé.</p>
            
            <button onclick="handleLogout()" class="w-full py-4 bg-red-500 hover:bg-red-600 text-white font-bold rounded-2xl transition-all">
                Changer de compte
            </button>
        </div>
    </div>

    <!-- Interface Principale -->
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-16">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="layout-grid" class="text-white"></i>
                </div>
                <h1 class="text-3xl font-bold text-white">LevelUp Studio</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="connection-status" class="flex items-center gap-3 px-5 py-2.5 bg-slate-900/80 rounded-2xl border border-white/5">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span id="user-display" class="text-xs font-bold text-slate-400">Vérification...</span>
                </div>
                <button onclick="handleLogout()" class="p-2.5 bg-white/5 hover:bg-red-500/20 rounded-xl text-slate-400 transition-all">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div class="admin-card p-8 rounded-[2rem] space-y-6">
                    <h3 class="font-bold text-xl flex items-center gap-2"><i data-lucide="sliders" class="text-blue-500 w-5 h-5"></i> Contrôles</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-black/20 p-4 rounded-xl">
                            <label class="block text-[10px] font-black uppercase text-slate-500 mb-2">Statut Session</label>
                            <select id="isSessionOpen" onchange="updateSettings()" class="w-full bg-transparent border-none text-white font-bold focus:ring-0">
                                <option value="true">OUVERT</option>
                                <option value="false">FERMÉ</option>
                            </select>
                        </div>
                        <div class="bg-black/20 p-4 rounded-xl">
                            <label class="block text-[10px] font-black uppercase text-slate-500 mb-2">Progression (%)</label>
                            <input type="number" id="progressVal" onchange="updateSettings()" class="w-full bg-transparent border-none text-blue-500 font-black focus:ring-0">
                        </div>
                    </div>
                </div>

                <div class="admin-card p-8 rounded-[2rem] space-y-4">
                    <h3 class="font-bold text-xl flex items-center gap-2"><i data-lucide="message-square" class="text-blue-500 w-5 h-5"></i> Annonce Client</h3>
                    <input type="text" id="statusTitle" class="w-full p-4 rounded-xl bg-slate-950 border border-white/10" placeholder="Titre..." onchange="updateSettings()">
                    <textarea id="statusDescription" class="w-full p-4 rounded-xl bg-slate-950 border border-white/10 h-32" placeholder="Message détaillé..." onchange="updateSettings()"></textarea>
                </div>
            </div>

            <div class="lg:col-span-1">
                <h2 class="text-sm font-black uppercase tracking-widest mb-4 px-2">Dernières Demandes</h2>
                <div id="requests-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
            </div>
        </div>
    </div>

    <!-- Console de Debug -->
    <div id="debug-container" class="fixed bottom-4 right-4 w-72 admin-card rounded-xl border border-white/20 overflow-hidden shadow-2xl z-[9999]">
        <div class="bg-slate-900 px-3 py-2 border-b border-white/10 flex justify-between items-center">
            <span class="text-[9px] font-black text-blue-400">SÉCURITÉ MONITOR</span>
            <button onclick="clearLogs()" class="text-[8px] text-slate-500 uppercase font-bold">Clear</button>
        </div>
        <div id="debug-console" class="p-3 max-h-48 overflow-y-auto space-y-1 console-log bg-black/40"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBJGVLBN2a2-CaoSH4Jtn3aRjIHqOO-7E",
            authDomain: "bonteia.firebaseapp.com",
            projectId: "bonteia",
            storageBucket: "bonteia.firebasestorage.app",
            messagingSenderId: "665809390410",
            appId: "1:665809390410:web:4fd0930b09aecd8f90cfb3"
        };

        const appId = 'levelup-studio';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const log = (msg, type = 'info') => {
            const consoleEl = document.getElementById('debug-console');
            const entry = document.createElement('div');
            const colors = { info: 'text-blue-400', success: 'text-green-400', error: 'text-red-400 font-bold', warn: 'text-yellow-400' };
            entry.className = colors[type] || 'text-white';
            entry.innerHTML = `> ${msg}`;
            consoleEl.prepend(entry);
        };

        window.handleGoogleLogin = async () => {
            try {
                log("Ouverture popup Google...", "info");
                // Étape critique : On s'assure d'écrire ton e-mail avant que la vérification ne tourne
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'admins', 'richelieubonte@gmail.com'), { role: 'owner' });
                log("E-mail admin pré-autorisé.", "success");
                await signInWithPopup(auth, provider);
            } catch (e) {
                log("Erreur login: " + e.code, "error");
            }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            const overlay = document.getElementById('auth-overlay');
            const forbidden = document.getElementById('forbidden-overlay');
            const userDisplay = document.getElementById('user-display');
            
            if (user) {
                log(`Vérification pour: ${user.email}...`);
                const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', user.email);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    log("Accès Admin confirmé !", "success");
                    overlay.classList.add('hidden');
                    forbidden.classList.add('hidden');
                    userDisplay.innerText = user.email;
                    loadData();
                } else {
                    log(`Accès refusé pour ${user.email}`, "error");
                    overlay.classList.add('hidden');
                    forbidden.classList.remove('hidden');
                    document.getElementById('forbidden-msg').innerText = `Le compte ${user.email} n'est pas autorisé.`;
                }
            } else {
                overlay.classList.remove('hidden');
            }
        });

        function loadData() {
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), (snap) => {
                if (snap.exists()) {
                    const d = snap.data();
                    document.getElementById('isSessionOpen').value = d.isSessionOpen.toString();
                    document.getElementById('progressVal').value = d.progress || 0;
                    document.getElementById('statusTitle').value = d.statusTitle || '';
                    document.getElementById('statusDescription').value = d.statusDescription || '';
                }
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                const list = document.getElementById('requests-list');
                list.innerHTML = snap.docs.map(doc => {
                    const r = doc.data();
                    return `
                        <div class="admin-card p-4 rounded-xl border-l-4 ${r.isDone ? 'border-l-green-500 opacity-50' : 'border-l-blue-500'}">
                            <div class="text-[10px] font-black text-blue-400 uppercase mb-1">${r.category}</div>
                            <div class="text-sm font-bold text-white mb-1">${r.pseudo}</div>
                            <div class="text-xs text-slate-400">${r.details}</div>
                        </div>
                    `;
                }).join('');
            });
        }

        window.updateSettings = async () => {
            const user = auth.currentUser;
            if(!user) return;
            try {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), {
                    isSessionOpen: document.getElementById('isSessionOpen').value === 'true',
                    progress: parseInt(document.getElementById('progressVal').value),
                    statusTitle: document.getElementById('statusTitle').value,
                    statusDescription: document.getElementById('statusDescription').value
                });
                log("Réglages mis à jour !", "success");
            } catch (e) {
                log("Erreur de sauvegarde: " + e.code, "error");
            }
        };

        window.clearLogs = () => document.getElementById('debug-console').innerHTML = "";
        lucide.createIcons();
    </script>
</body>
</html>
