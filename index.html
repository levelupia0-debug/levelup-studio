<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LevelUp Admin - Premium Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-deep: #020617;
            --accent: #3b82f6;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep); 
            color: #f8fafc;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(147, 51, 234, 0.08) 0%, transparent 40%);
            min-height: 100vh;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(20px); 
        }

        .card-glow:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.1);
        }

        .toggle-btn { transition: all 0.3s ease; }
        .toggle-active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-item { animation: fadeIn 0.3s ease forwards; }
    </style>
</head>
<body class="p-4 md:p-10">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 flex items-center justify-center p-4 z-[100] bg-[#020617]">
        <div class="glass p-12 rounded-[3.5rem] w-full max-w-md text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-2xl shadow-blue-500/20">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2 text-white">LevelUp Admin</h2>
            <p class="text-slate-400 text-sm mb-10">Connexion sécurisée requise</p>
            <button onclick="handleGoogleLogin()" class="w-full py-4 bg-white text-slate-950 font-bold rounded-2xl hover:bg-slate-100 flex items-center justify-center gap-3 transition-all">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                Se connecter avec Google
            </button>
        </div>
    </div>

    <!-- Forbidden Overlay -->
    <div id="forbidden-overlay" class="fixed inset-0 flex items-center justify-center p-4 z-[101] bg-[#020617] hidden">
        <div class="glass p-12 rounded-[3.5rem] w-full max-w-md text-center border-red-500/20">
            <div class="w-20 h-20 bg-red-500/10 rounded-[2rem] flex items-center justify-center mx-auto mb-8">
                <i data-lucide="lock" class="text-red-500 w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-4">Accès Refusé</h2>
            <p id="forbidden-msg" class="text-slate-400 text-sm mb-10"></p>
            <button onclick="handleLogout()" class="w-full py-4 bg-slate-800 text-white font-bold rounded-2xl hover:bg-slate-700 transition-all">
                Changer de compte
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex items-center justify-between mb-12">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="layers" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold">LevelUp <span class="text-blue-500">Studio</span></h1>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Administration</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 glass px-5 py-2 rounded-2xl">
                <div class="text-right hidden sm:block">
                    <p id="user-display" class="text-xs font-bold text-white tracking-tight">Vérification...</p>
                    <p class="text-[9px] text-green-500 font-bold uppercase">Online</p>
                </div>
                <button onclick="handleLogout()" class="w-9 h-9 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-500 rounded-xl transition-all flex items-center justify-center">
                    <i data-lucide="power" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left: Controls -->
            <div class="lg:col-span-7 space-y-8">
                
                <!-- Status Toggle -->
                <div class="glass p-8 rounded-[2.5rem] card-glow">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="font-bold text-lg">Statut du Studio</h3>
                            <p class="text-xs text-slate-500">Ouvrir ou fermer les prises de commandes</p>
                        </div>
                        <div id="status-badge" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider">Chargement...</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 p-1.5 bg-black/30 rounded-[1.5rem] border border-white/5">
                        <button id="btn-open" onclick="updateUIStatus(true, true)" class="toggle-btn py-4 rounded-2xl flex items-center justify-center gap-3 font-bold text-sm">
                            <i data-lucide="unlock" class="w-4 h-4"></i> OUVERT
                        </button>
                        <button id="btn-close" onclick="updateUIStatus(false, true)" class="toggle-btn py-4 rounded-2xl flex items-center justify-center gap-3 font-bold text-sm">
                            <i data-lucide="lock" class="w-4 h-4"></i> FERMÉ
                        </button>
                    </div>
                </div>

                <!-- Progress Slider -->
                <div class="glass p-8 rounded-[2.5rem] card-glow">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg">Progression Actuelle</h3>
                        <span id="progress-percent" class="text-blue-500 font-black text-xl">0%</span>
                    </div>
                    <input type="range" id="progressVal" min="0" max="100" step="1" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="document.getElementById('progress-percent').innerText = this.value + '%'" onchange="updateSettings()">
                </div>

                <!-- Announcements -->
                <div class="glass p-8 rounded-[2.5rem] card-glow">
                    <h3 class="font-bold text-lg mb-6 flex items-center gap-2 text-blue-500">
                        <i data-lucide="megaphone" class="w-5 h-5"></i> Annonce Client
                    </h3>
                    <div class="space-y-5">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Titre de l'annonce</label>
                            <input type="text" id="statusTitle" class="w-full bg-black/20 border border-white/5 rounded-2xl p-4 text-white font-semibold focus:border-blue-500/50 outline-none transition-all" onchange="updateSettings()">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">Message</label>
                            <textarea id="statusDescription" class="w-full bg-black/20 border border-white/5 rounded-2xl p-4 text-slate-300 h-32 outline-none focus:border-blue-500/50 transition-all resize-none" onchange="updateSettings()"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Requests -->
            <div class="lg:col-span-5 space-y-6">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xs font-bold uppercase tracking-widest text-slate-500">Demandes Clients</h2>
                    <span id="req-count" class="bg-blue-600/20 text-blue-500 text-[10px] px-3 py-1 rounded-full font-black border border-blue-500/20">0</span>
                </div>
                
                <div id="requests-list" class="space-y-4 max-h-[80vh] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Les demandes s'affichent ici -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBJGVLBN2a2-CaoSH4Jtn3aRjIHqOO-7E",
            authDomain: "bonteia.firebaseapp.com",
            projectId: "bonteia",
            storageBucket: "bonteia.firebasestorage.app",
            messagingSenderId: "665809390410",
            appId: "1:665809390410:web:4fd0930b09aecd8f90cfb3"
        };

        const appId = 'levelup-studio';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let isSessionOpen = false;
        let isInitialLoad = true; // Empêche l'écrasement des données au démarrage

        // Mise à jour de l'UI (Boutons + Badge)
        window.updateUIStatus = (status, shouldSave = false) => {
            isSessionOpen = status;
            const btnOpen = document.getElementById('btn-open');
            const btnClose = document.getElementById('btn-close');
            const badge = document.getElementById('status-badge');

            if(status) {
                btnOpen.classList.add('toggle-active');
                btnClose.classList.remove('toggle-active');
                badge.innerText = "Actif";
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider bg-green-500/10 text-green-500 border border-green-500/20";
            } else {
                btnClose.classList.add('toggle-active');
                btnOpen.classList.remove('toggle-active');
                badge.innerText = "Fermé";
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider bg-red-500/10 text-red-500 border border-red-500/20";
            }

            if(shouldSave && !isInitialLoad) updateSettings();
        };

        window.handleGoogleLogin = async () => {
            try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const email = user.email.toLowerCase();
                const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', email);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('user-display').innerText = email;
                    loadRealtimeData();
                } else {
                    document.getElementById('auth-overlay').classList.add('hidden');
                    document.getElementById('forbidden-overlay').classList.remove('hidden');
                    document.getElementById('forbidden-msg').innerText = `L'adresse ${email} n'est pas autorisée.`;
                }
            } else {
                document.getElementById('auth-overlay').classList.remove('hidden');
            }
        });

        function loadRealtimeData() {
            // Settings Sync
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), (snap) => {
                if (snap.exists()) {
                    isInitialLoad = true; // Désactive la sauvegarde auto pendant le remplissage
                    const d = snap.data();
                    updateUIStatus(d.isSessionOpen || false, false);
                    document.getElementById('progressVal').value = d.progress || 0;
                    document.getElementById('progress-percent').innerText = (d.progress || 0) + '%';
                    document.getElementById('statusTitle').value = d.statusTitle || '';
                    document.getElementById('statusDescription').value = d.statusDescription || '';
                    setTimeout(() => isInitialLoad = false, 1000); // Réactive après 1s
                }
            });

            // Requests Sync
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                const list = document.getElementById('requests-list');
                document.getElementById('req-count').innerText = snap.size;
                
                const requests = snap.docs.map(d => d.data());
                list.innerHTML = requests.map(r => `
                    <div class="glass p-5 rounded-3xl border border-white/5 animate-item">
                        <div class="flex justify-between mb-3">
                            <span class="text-[9px] font-bold text-blue-400 bg-blue-400/10 px-2 py-0.5 rounded border border-blue-400/20 uppercase">
                                ${r.category || 'Standard'}
                            </span>
                        </div>
                        <div class="text-sm font-bold text-white mb-1">${r.pseudo || 'Anonyme'}</div>
                        <p class="text-xs text-slate-400 leading-relaxed">${r.details || '-'}</p>
                    </div>
                `).reverse().join('');
            });
        }

        window.updateSettings = async () => {
            if(!auth.currentUser || isInitialLoad) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), {
                    isSessionOpen: isSessionOpen,
                    progress: parseInt(document.getElementById('progressVal').value),
                    statusTitle: document.getElementById('statusTitle').value,
                    statusDescription: document.getElementById('statusDescription').value
                }, { merge: true });
            } catch (e) {
                console.error("Erreur Firebase:", e);
            }
        };

        lucide.createIcons();
    </script>
</body>
</html>
