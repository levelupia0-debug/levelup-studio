<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LevelUp Admin - Premium Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --bg-deep: #020617;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.4);
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep); 
            color: #f8fafc;
            background-image: 
                radial-gradient(circle at 10% 10%, rgba(59, 130, 246, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 90%, rgba(147, 51, 234, 0.08) 0%, transparent 40%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .glass { 
            background: rgba(15, 23, 42, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            backdrop-filter: blur(20px); 
        }

        .card-glow {
            transition: all 0.4s ease;
        }

        .card-glow:hover {
            border-color: rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.1);
        }

        .toggle-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        #auth-overlay, #forbidden-overlay {
            background: #020617;
            z-index: 100;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }

        @keyframes slideIn {
            from { transform: translateY(10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide { animation: slideIn 0.4s ease forwards; }
    </style>
</head>
<body class="p-4 md:p-10">

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 flex items-center justify-center p-4">
        <div class="glass p-12 rounded-[3.5rem] w-full max-w-md text-center">
            <div class="w-20 h-20 bg-blue-600 rounded-[2rem] flex items-center justify-center mx-auto mb-8 shadow-2xl shadow-blue-500/20">
                <i data-lucide="shield-check" class="text-white w-10 h-10"></i>
            </div>
            <h2 class="text-3xl font-bold mb-2">LevelUp Admin</h2>
            <p class="text-slate-400 text-sm mb-10 tracking-wide font-medium">Authentification requise</p>
            <button onclick="handleGoogleLogin()" class="w-full py-4 bg-white text-slate-950 font-bold rounded-2xl hover:bg-slate-100 flex items-center justify-center gap-3 transition-all">
                <i data-lucide="log-in" class="w-5 h-5"></i>
                Continuer avec Google
            </button>
        </div>
    </div>

    <!-- Forbidden Overlay -->
    <div id="forbidden-overlay" class="fixed inset-0 flex items-center justify-center p-4 hidden">
        <div class="glass p-12 rounded-[3.5rem] w-full max-w-md text-center border-red-500/20">
            <div class="w-20 h-20 bg-red-500/10 rounded-[2rem] flex items-center justify-center mx-auto mb-8">
                <i data-lucide="lock" class="text-red-500 w-10 h-10"></i>
            </div>
            <h2 class="text-2xl font-bold text-white mb-4">Accès Non Autorisé</h2>
            <p id="forbidden-msg" class="text-slate-400 text-sm mb-10 leading-relaxed"></p>
            <button onclick="handleLogout()" class="w-full py-4 bg-slate-800 text-white font-bold rounded-2xl hover:bg-slate-700 transition-all">
                Changer de compte
            </button>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="flex items-center justify-between mb-16">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="layers" class="text-white w-6 h-6"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">LevelUp <span class="text-blue-500">Studio</span></h1>
                    <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Management Suite</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4 glass px-5 py-2.5 rounded-2xl">
                <div class="text-right hidden sm:block">
                    <p id="user-display" class="text-xs font-bold text-white">Admin</p>
                    <p class="text-[9px] text-green-500 font-bold uppercase">En ligne</p>
                </div>
                <button onclick="handleLogout()" class="w-10 h-10 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-500 rounded-xl transition-all flex items-center justify-center">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <!-- Main Controls -->
            <div class="lg:col-span-7 space-y-10">
                
                <!-- Status Switcher -->
                <div class="glass p-8 rounded-[2.5rem] card-glow">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h3 class="font-bold text-lg">État du Studio</h3>
                            <p class="text-xs text-slate-500">Gérez l'ouverture des sessions publiques</p>
                        </div>
                        <div id="status-badge" class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 p-1.5 bg-black/40 rounded-[1.5rem] border border-white/5">
                        <button id="btn-open" onclick="setStatus(true)" class="toggle-btn py-4 rounded-2xl flex items-center justify-center gap-3 font-bold text-sm">
                            <i data-lucide="unlock" class="w-4 h-4"></i>
                            OUVERT
                        </button>
                        <button id="btn-close" onclick="setStatus(false)" class="toggle-btn py-4 rounded-2xl flex items-center justify-center gap-3 font-bold text-sm">
                            <i data-lucide="lock-keyhole" class="w-4 h-4"></i>
                            FERMÉ
                        </button>
                    </div>
                </div>

                <!-- Global Progress -->
                <div class="glass p-8 rounded-[2.5rem] card-glow">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-bold text-lg">Progression Générale</h3>
                        <span id="progress-percent" class="text-blue-500 font-black text-xl">0%</span>
                    </div>
                    <input type="range" id="progressVal" min="0" max="100" class="w-full h-2 bg-slate-800 rounded-lg appearance-none cursor-pointer accent-blue-500" oninput="updateProgressUI(this.value)" onchange="updateSettings()">
                    <div class="flex justify-between mt-4 text-[10px] font-bold text-slate-600 uppercase tracking-widest">
                        <span>Phase Début</span>
                        <span>Phase Finale</span>
                    </div>
                </div>

                <!-- Global Announcements -->
                <div class="glass p-8 rounded-[2.5rem] card-glow">
                    <h3 class="font-bold text-lg mb-6 flex items-center gap-2">
                        <i data-lucide="megaphone" class="w-5 h-5 text-blue-500"></i>
                        Annonce Client
                    </h3>
                    <div class="space-y-4">
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Titre de l'alerte</label>
                            <input type="text" id="statusTitle" class="w-full bg-black/30 border border-white/5 rounded-2xl p-4 text-white font-semibold focus:border-blue-500/50 outline-none transition-all" placeholder="Ex: Maintenance en cours..." onchange="updateSettings()">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-slate-500 uppercase ml-2">Message détaillé</label>
                            <textarea id="statusDescription" class="w-full bg-black/30 border border-white/5 rounded-2xl p-4 text-slate-300 h-32 outline-none focus:border-blue-500/50 transition-all resize-none" placeholder="Décrivez la situation actuelle..." onchange="updateSettings()"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Requests Sidebar -->
            <div class="lg:col-span-5 space-y-6">
                <div class="flex items-center justify-between px-2">
                    <h2 class="text-xs font-bold uppercase tracking-[0.2em] text-slate-500">Flux de demandes</h2>
                    <span id="req-count" class="bg-blue-600/20 text-blue-500 text-[10px] px-3 py-1 rounded-full font-black border border-blue-500/20">0</span>
                </div>
                
                <div id="requests-list" class="space-y-4 max-h-[85vh] overflow-y-auto pr-2 custom-scrollbar">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBBJGVLBN2a2-CaoSH4Jtn3aRjIHqOO-7E",
            authDomain: "bonteia.firebaseapp.com",
            projectId: "bonteia",
            storageBucket: "bonteia.firebasestorage.app",
            messagingSenderId: "665809390410",
            appId: "1:665809390410:web:4fd0930b09aecd8f90cfb3"
        };

        const appId = 'levelup-studio';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        let currentStatus = false;

        // UI Helpers
        window.setStatus = (status) => {
            currentStatus = status;
            const btnOpen = document.getElementById('btn-open');
            const btnClose = document.getElementById('btn-close');
            const badge = document.getElementById('status-badge');

            if(status) {
                btnOpen.classList.add('toggle-active');
                btnClose.classList.remove('toggle-active');
                badge.innerText = "Public : Actif";
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider bg-green-500/10 text-green-500 border border-green-500/20";
            } else {
                btnClose.classList.add('toggle-active');
                btnOpen.classList.remove('toggle-active');
                badge.innerText = "Public : Fermé";
                badge.className = "px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-wider bg-slate-500/10 text-slate-500 border border-slate-500/20";
            }
            updateSettings();
        };

        window.updateProgressUI = (val) => {
            document.getElementById('progress-percent').innerText = val + '%';
        };

        // Firebase Logic
        window.handleGoogleLogin = async () => {
            try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
        };

        window.handleLogout = async () => {
            await signOut(auth);
            location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            const overlay = document.getElementById('auth-overlay');
            const forbidden = document.getElementById('forbidden-overlay');
            const userDisplay = document.getElementById('user-display');
            
            if (user) {
                const email = user.email.toLowerCase();
                const adminRef = doc(db, 'artifacts', appId, 'public', 'data', 'admins', email);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    overlay.classList.add('hidden');
                    forbidden.classList.add('hidden');
                    userDisplay.innerText = email.split('@')[0];
                    loadData();
                } else {
                    overlay.classList.add('hidden');
                    forbidden.classList.remove('hidden');
                    document.getElementById('forbidden-msg').innerText = `Le compte ${email} n'est pas autorisé à accéder à cette console.`;
                }
            } else {
                overlay.classList.remove('hidden');
            }
        });

        function loadData() {
            // Load Settings
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), (snap) => {
                if (snap.exists()) {
                    const d = snap.data();
                    window.setStatus(d.isSessionOpen);
                    document.getElementById('progressVal').value = d.progress || 0;
                    window.updateProgressUI(d.progress || 0);
                    document.getElementById('statusTitle').value = d.statusTitle || '';
                    document.getElementById('statusDescription').value = d.statusDescription || '';
                }
            });

            // Load Requests
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), (snap) => {
                const list = document.getElementById('requests-list');
                document.getElementById('req-count').innerText = snap.size;
                
                const docs = snap.docs.map(doc => ({id: doc.id, ...doc.data()}))
                                .sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));

                list.innerHTML = docs.map(r => `
                    <div class="glass p-6 rounded-3xl border border-white/5 animate-slide">
                        <div class="flex justify-between items-start mb-4">
                            <span class="px-2 py-0.5 bg-blue-500/10 text-blue-500 text-[9px] font-black uppercase rounded-md border border-blue-500/10">
                                ${r.category || 'Général'}
                            </span>
                        </div>
                        <div class="text-sm font-bold text-white mb-2">${r.pseudo || 'Anonyme'}</div>
                        <p class="text-xs text-slate-400 leading-relaxed">${r.details || 'Aucun détail'}</p>
                    </div>
                `).join('');
            });
        }

        window.updateSettings = async () => {
            if(!auth.currentUser) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main'), {
                    isSessionOpen: currentStatus,
                    progress: parseInt(document.getElementById('progressVal').value),
                    statusTitle: document.getElementById('statusTitle').value,
                    statusDescription: document.getElementById('statusDescription').value
                }, { merge: true });
            } catch (e) {
                console.error("Erreur de sauvegarde:", e);
            }
        };

        lucide.createIcons();
    </script>
</body>
</html>
